# Задание №6. Генерализация цифровой модели рельефа {#ex-dem}

**Цель задания** --- овладение различными техниками генерализации ЦМР.

В настоящем задании необходимо сравнить два метода мелкомасштабной генерализации ЦМР: глобальная фильтрация и структурная генерализация. 

__Задачи__ работы включают подготовку исходных данных, разработку программного инструмента итерационного сглаживания ЦМР, выполнение генерализации ЦМР методами структурной генерализации и глобальной фильтрации, а также сравнительный анализ полученных результатов

## Подготовка исходных данных {#ex-dem-data}

1. Закачайте набор инструментов [DEM Generalization](https://github.com/tsamsonov/generalize-dem) и разархивируйте его:
    
    ```{r demgen, out.width = "100%", fig.cap="Инструмент генерализации ЦМР DEM Generalization"}
    knitr::include_graphics("img/generalize-dem.png")
    ```

1. Закачайте фрагмент ЦМР _GEBCO 2019_ размером $10^\circ \times 10^\circ$, используя [веб-интерфейс](https://download.gebco.net/). Для этого включите показ градусной сетки (_Show graticule_), выберите формат _GeoTIFF_ и, используя CTRL + клик, обведите квадрат со сторонами, примерно совпадающими с линиями сетки, кратными 5 градусам:
    
    ```{r gebco-download, out.width = "100%", fig.cap="Загрузка цифровой модели рельефа GEBCO 2019"}
    knitr::include_graphics("img/download-gebco.png")
    ```
    
    На выбор предлагаются фрагменты с центрами в следующих точках:
    - Красное море ($40; 15$);
    - Альпы ($10; 45$);
    - Норвегия ($10; 60$);
    - Южный Каспий ($50; 40$);
    - Центральные Анды ($-70; -15$);
    - Северные Анды ($-75; 5$);
    - Аляска ($-150; 60$);
    - Камчатка ($160; 55$);
    - Австралия ($150; -35$);
    - Калифорния ($-120; 35$)
    
1. Закачайте [данные](https://www.naturalearthdata.com/downloads/10m-physical-vectors/) Natural Earth масштаба 1:10 000 000 для следующих слоев:
    - береговая линия (_Coastline_);
    - океан (_Ocean_);
    - гидрография площадная (_Rivers + lake centerlines_);
    - гидрография линейная (_Lakes + Reservoirs_)

1. Получите охват скачанного растра в качестве полигона (__Raster Domain__).

1. Обрежьте полученным полигоном данные Natural Earth (__Clip__).

1. Перепроецируйте все исходные данные (ЦМР + три векторных слоя) в цилиндрическую равнопромежуточную проекцию _World_Plate_Carree_. 

    > Если операция выполнена верно, то проецированная версия ЦМР должна в точности совпадать с исходной как по размерам, так и по значениям. Отличие будет заключаться только в координатах ячеек, которые от градусов перейдут в метрические.
    
## Автоматизация итерационного сглаживания ЦМР {#ex-dem-iter}

В данной части задания необходимо создать набор инструментов _Python Toolbox_, содержащий один инструмент __Iterate Focal Statistics__, который выполняет последовательное сглаживание цифровой модели рельефа фильтром среднего в несколько проходов с использованием заданных параметров.

__Предварительное чтение:__

1. Синтаксис вызова инструмента [Focal Statistics](http://desktop.arcgis.com/ru/arcmap/10.5/tools/spatial-analyst-toolbox/focal-statistics.htm) средствами языка программирования Python.
1. Создание нового набора инструментов [Python Toolbox](http://desktop.arcgis.com/ru/arcmap/10.5/analyze/creating-tools/creating-a-new-python-toolbox.htm).

__Параметры инструмента:__

1. Входная ЦМР (_Input Raster DEM_).
1. Размер плавающего окна (_Filter size_).
1. Количество итераций (_Number of iterations_).
1. Выходная ЦМР (_Output Raster DEM_).

__Указания к выполнению:__

1. Скачайте [шаблон](http://desktop.arcgis.com/ru/arcmap/10.5/analyze/creating-tools/a-template-for-python-toolboxes.htm) инструмента Python Toolbox.
1. Переименуйте шаблон в `Ex6.pyt`.
1. Модифицируйте шаблон, дав основному инструменту название `Iterate Focal Statistics` и определив в нем необходимые [параметры](http://desktop.arcgis.com/ru/arcmap/10.5/analyze/creating-tools/defining-parameters-in-a-python-toolbox.htm) и их [типы](http://desktop.arcgis.com/ru/arcmap/10.5/analyze/creating-tools/defining-parameter-data-types-in-a-python-toolbox.htm).
1. Добавьте строку импорта функций модуля __Spatial Analyst__: `from arcpy.sa import *`.
1. Выполните редактирование функции `execute()`, включив в нее следующие шаги (_вместо многоточия подставьте нужные параметры_):

    - [Чтение параметров](http://desktop.arcgis.com/ru/arcmap/10.5/analyze/creating-tools/accessing-parameters-within-a-python-toolbox.htm) инструмента в теле функции. Например: `in_raster = parameters[0].valueAsText`.
    - Создание объекта типа [Raster](https://desktop.arcgis.com/ru/arcmap/latest/extensions/spatial-analyst/map-algebra/working-with-raster-objects.htm) из слоя входной ЦМР: `dem = Raster(...)`.
    - Создание [прямоугольной окрестности](http://desktop.arcgis.com/ru/arcmap/10.5/analyze/arcpy-spatial-analyst/nbrrectangle-class.htm) заданного размера: `nbr = NbrRectangle(...)`.
    - Организация цикла от $0$ до $N-1$, где $N$ — количество итераций, переданное в качестве параметра инструмента: `for i in range(N):`. Внутри цикла:
        - Вывод сообщения о текущем номере итерации: `arcpy.AddMessage(...)`.
        - Вызов функции [фокальной статистики](http://desktop.arcgis.com/ru/arcmap/10.5/tools/spatial-analyst-toolbox/focal-statistics.htm) с созданной ранее окрестностью. Чтобы на каждой итерации на вход подавался результат выполнения предыдущей итерации, просто записывайте его в ту же переменную: `dem = FocalStatistics(dem, ...)`.
    - Сохранение полученного растра в выходной набор данных _Output Raster DEM_: `dem.save(...)`.
    
## Сравнение структурной генерализации и глобальной фильтрации ЦМР {#ex-dem-iter}

В данной части задания необходимо выполнить генерализацию фрагмента глобальной ЦМР двумя методами: структурная генерализация и глобальная фильтрация.

1. Выполните генерализацию ЦМР с использованием инструмента __Generalize DEM__, указав слой _ocean_ в качестве параметра _Marine area polygon feature layer_. Для начала выполните генерализацию со стандартными параметрами, после этого включите сглаживание ЦМР в блоке _Widening and Smoothing_ и усильте генерализационный эффект в блоке _Main parameters_ таким образом чтобы результирующая ЦМР по детализации соответствовала масштабу 1:10 000 000. 

1. Выполните генерализацию ЦМР с использованием созданного вами инструмента __Iterate Focal Statistics__. Используйте размер окна, равный 5 ячейкам и подберите количество итераций такое, при котором детализация сглаженной ЦМР будет равна результату, полученному методом структурной генерализации.

1. Создайте таблицу описательных статистик исходной и генерализованных ЦМР, включающую следующие столбцы:

    - минимум;
    - максимум;
    - среднее;
    - стандартное отклонение;

1. Постройте по ЦМР горизонтали на следующих уровнях (можно взять то подмножество, которое релевантно для вашей области):

    - -12000
    - -10000
    - -8000
    - -6000
    - -5000
    - -4500
    - -4000
    - -3500
    - -3000
    - -2500
    - -2000
    - -1500
    - -1000
    - -500
    - -200
    - -100
    - -50
    - 0
    - 50
    - 100
    - 150
    - 200
    - 300
    - 500
    - 750
    - 1000
    - 1250
    - 1500
    - 1750
    - 2000
    - 2500
    - 3000
    - 3500
    - 4000
    - 4500
    - 5000
    - 6000
    - 7000
    - 8000
    - 9000

1. Отобразите три цифровые модели рельефа в единой гипсометрической шкале с вышеуказанными ступенями. Спроектируйте цветовую шкалу, на которой будут хорошо различимы указанные ступени.

1. Добавьте объекты береговой линии, линейной и площадной гидрографии. В  проекте одновремененно должны отображаться следующие слои: цифровая модель рельефа, горизонтали, береговая линия, гидрография линейная, гидрография площадная.

1. Экспортируйте три изображения в масштабе 1:10 000 000:

    - Исходная ЦМР
    - Структурная генерализация
    - Генерализация методом глобальной фильтрации
    
1. Напишите отчет о проделанной работе, который включает следующие пункты:

    - Цель и задачи
    - Источники данных
    - Алгоритмы генерализации (пошаговое описание).
    - Ход выполнения работы
    - Анализ результатов

В разделе анализа результатов необходимо сравнить качество полученных ЦМР с точки зрения географического правдоподобия и точности отображения рельефа. Анализ должен опираться как на визуальное сравнение изображений, так и на рассчитанные для каждой ЦМР описательные статистики.

---


